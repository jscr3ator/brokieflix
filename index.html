<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BrokieFlix - Free Movie & TV Streaming</title>
    <meta name="description" content="Watch all your favorite movies and TV shows for free on BrokieFlix. Search, discover, and stream in high quality."/>
    <meta name="author" content="jscreator" />
    <link rel="icon" type="image/svg+xml" href="logo.png">
    <link rel="icon" href="/favicon.svg" sizes="any">
    <link rel="apple-touch-icon" href="/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --background: 224 71% 4%;
            --foreground: 210 40% 98%;
            --surface: 224 71% 10%;
            --surface-elevated: 224 71% 14%;
            --primary: 259 95% 62%;
            --primary-foreground: 210 40% 98%;
            --primary-glow: 259 95% 72%;
            --secondary: 217 33% 17%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217 33% 25%;
            --muted-foreground: 215 20% 65%;
            --border: 217 33% 20%;
            --ring: 259 95% 62%;
            --radius: 0.75rem;
        }

        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            font-family: 'Poppins', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .glass {
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            background-color: hsl(var(--surface) / 0.7);
            border-bottom: 1px solid hsl(var(--border) / 0.5);
        }

        .shimmer {
            background: linear-gradient(90deg, hsl(var(--surface)) 25%, hsl(var(--surface-elevated)) 50%, hsl(var(--surface)) 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite linear;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); }
        }


        .custom-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .hover-scale { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .hover-scale:hover { transform: scale(1.05); }

        .btn-primary {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-primary:hover {
            background-color: hsl(var(--primary-glow));
            transform: scale(1.05);
            box-shadow: 0 0 25px hsl(var(--primary) / 0.5);
        }
        .btn-primary:disabled {
            background-color: hsl(var(--muted));
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-secondary:hover {
            background-color: hsl(var(--secondary) / 0.8);
            transform: scale(1.05);
            border-color: hsl(var(--primary));
        }

        .glow-border:hover {
             border-color: hsl(var(--primary));
             box-shadow: 0 0 15px hsl(var(--primary) / 0.3);
        }

        /* Toggle Switch Styles */
        .toggle-switch-container {
            position: relative;
            display: flex;
            align-items: center;
            background-color: hsl(var(--surface));
            border-radius: 9999px;
            padding: 4px;
            border: 1px solid hsl(var(--border));
        }

        .toggle-switch-option {
            position: relative;
            z-index: 10;
            padding: 6px 12px;
            font-size: 14px;
            font-weight: 500;
            color: hsl(var(--muted-foreground));
            cursor: pointer;
            transition: color 0.4s cubic-bezier(0.2, 0, 0, 1);
            border-radius: 9999px;
        }

        .toggle-switch-option.active {
            color: hsl(var(--primary-foreground));
        }

        .toggle-switch-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            height: calc(100% - 8px);
            background-color: hsl(var(--primary));
            border-radius: 9999px;
            transition: transform 0.4s cubic-bezier(0.2, 0, 0, 1), width 0.4s cubic-bezier(0.2, 0, 0, 1);
            box-shadow: 0 0 15px hsl(var(--primary) / 0.5);
        }
        
        .modal-content {
            animation: slideInUp 0.4s cubic-bezier(0.2, 0, 0, 1) forwards;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Page Refresh Animation */
        .page-refresh-out {
            animation: page-refresh-out 0.3s ease-in forwards;
        }
        @keyframes page-refresh-out {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.97); }
        }
        .page-refresh-in {
            animation: page-refresh-in 0.4s ease-out forwards;
        }
        @keyframes page-refresh-in {
            from { opacity: 0; transform: scale(0.97); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Input Fixes */
        input[type="text"] {
            color: hsl(var(--foreground));
        }
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active{
            -webkit-box-shadow: 0 0 0 30px hsl(var(--surface-elevated)) inset !important;
            -webkit-text-fill-color: hsl(var(--foreground)) !important;
            caret-color: hsl(var(--foreground)) !important;
        }
    </style>
</head>
<body class="bg-background text-foreground">
    <div id="app" class="min-h-screen">
        </div>
    <div id="modal-container"></div>

    <script type="module">
        // --- SERVICES ---
        let TMDB_API_KEY = '';
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        const TMDB_IMAGE_BASE_URL = 'https://image.tmdb.org/t/p';
        const CONSUMET_API_URL = 'https://api.consumet.org';

        const tmdbService = {
            async fetchFromAPI(endpoint, params = {}) {
                if (!TMDB_API_KEY) {
                    console.error("TMDB API Key is not set.");
                    return { results: [] };
                }
                const url = new URL(`${TMDB_BASE_URL}${endpoint}`);
                url.searchParams.append('api_key', TMDB_API_KEY);
                Object.entries(params).forEach(([key, value]) => {
                    if (value) url.searchParams.append(key, String(value))
                });
                try {
                    const response = await fetch(url.toString());
                    if (!response.ok) throw new Error(`TMDb API error: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error('TMDb API fetch error:', error);
                    throw error;
                }
            },
            getImageUrl: (path, size = 'w500') => path ? `${TMDB_IMAGE_BASE_URL}/${size}${path}` : 'https://placehold.co/500x750/0a0e1a/e0e0e0?text=No+Image',
            getBackdropUrl: (path, size = 'w1280') => path ? `${TMDB_IMAGE_BASE_URL}/${size}${path}` : 'https://placehold.co/1280x720/0a0e1a/e0e0e0?text=No+Image',
            getTrending: (mediaType = 'all', timeWindow = 'day') => tmdbService.fetchFromAPI(`/trending/${mediaType}/${timeWindow}`),
            getPopularMovies: (page = 1, options = {}) => tmdbService.fetchFromAPI('/movie/popular', { page, ...options }),
            getPopularTVShows: (page = 1, options = {}) => tmdbService.fetchFromAPI('/tv/popular', { page, ...options }),
            searchMulti: (query, page = 1) => tmdbService.fetchFromAPI('/search/multi', { query, page }),
            getMovieDetails: (id) => tmdbService.fetchFromAPI(`/movie/${id}`, { append_to_response: 'credits,recommendations,keywords,videos' }),
            getTVShowDetails: (id) => tmdbService.fetchFromAPI(`/tv/${id}`, { append_to_response: 'credits,recommendations,keywords,videos' }),
            getTVShowSeason: (id, seasonNumber) => tmdbService.fetchFromAPI(`/tv/${id}/season/${seasonNumber}`),
            discover: (type, params) => tmdbService.fetchFromAPI(`/discover/${type}`, params),
        };

        const streamingService = {
            getMovieSources: (id) => ([
                { name: 'Vidlink', url: `https://vidlink.pro/movie/${id}`},
                { name: 'Vidsrc', url: `https://vidsrc.xyz/embed/movie/${id}`},
                { name: '2Embed', url: `https://www.2embed.cc/embed/${id}`},
                { name: 'Vidjoy', url: `https://vidjoy.pro/embed/movie/${id}`},
                { name: 'Vidfast', url: `https://vidfast.pro/movie/${id}`},
                { name: 'Vidzee', url: `https://player.vidzee.wtf/embed/movie/${id}`},
                { name: 'Videasy', url: `https://player.videasy.net/movie/${id}`},
                { name: 'Embed.su', url: `https://embed.su/embed/movie/${id}`},
            ]),
            getTVSources: (id, season, episode) => ([
                { name: 'Vidlink', url: `https://vidlink.pro/tv/${id}/${season}/${episode}`},
                { name: 'Vidsrc', url: `https://vidsrc.xyz/embed/tv/${id}/${season}/${episode}`},
                { name: '2Embed', url: `https://www.2embed.cc/embedtv/${id}&s=${season}&e=${episode}`},
                { name: 'Vidjoy', url: `https://vidjoy.pro/embed/tv/${season}/${id}`},
                { name: 'Vidfast', url: `https://vidfast.pro/tv/${id}/${season}/${episode}`},
                { name: 'Vidzee', url: `https://player.vidzee.wtf/embed/tv/${season}/${id}`},
                { name: 'Videasy', url: `https://player.videasy.net/tv/${id}/${season}/${episode}`},
                { name: 'Embed.su', url: `https://embed.su/embed/tv/${id}/${season}/${episode}`},
            ]),
            async getAnimeSources(title, episodeNumber) {
                try {
                    // 1. Search for the anime on Gogoanime via Consumet API
                    const searchRes = await fetch(`${CONSUMET_API_URL}/anime/gogoanime/${encodeURIComponent(title)}`);
                    if (!searchRes.ok) throw new Error('Failed to search for anime.');
                    const searchData = await searchRes.json();
                    const anime = searchData.results?.[0];
                    if (!anime) throw new Error('Anime not found on Gogoanime.');
                    
                    // 2. Get anime details to find the episode ID
                    const detailsRes = await fetch(`${CONSUMET_API_URL}/anime/gogoanime/info/${anime.id}`);
                    if (!detailsRes.ok) throw new Error('Failed to get anime details.');
                    const detailsData = await detailsRes.json();
                    const episode = detailsData.episodes?.find(ep => ep.number == episodeNumber);
                    if (!episode) throw new Error(`Episode ${episodeNumber} not found.`);

                    // 3. Get streaming sources for the episode
                    const sourcesRes = await fetch(`${CONSUMET_API_URL}/anime/gogoanime/watch/${episode.id}`);
                    if (!sourcesRes.ok) throw new Error('Failed to get streaming sources.');
                    const sourcesData = await sourcesRes.json();
                    
                    // 4. Format the sources
                    return sourcesData.sources?.map(s => ({
                        name: `Gogoanime (${s.quality})`,
                        url: s.url,
                    })) || [];
                } catch (error) {
                    console.error("Error fetching anime sources:", error);
                    return []; // Return empty array on error instead of an error object
                }
            },
             async getDownloadLinks(tmdbId, type, season, episode) {
                try {
                    let url;
                    if (type === 'movie') {
                        url = `https://dl.vidzee.wtf/download/movie/v1/${tmdbId}`;
                    } else if (type === 'tv' && season && episode) {
                        url = `https://dl.vidzee.wtf/download/tv/v1/${tmdbId}/${season}/${episode}`;
                    } else {
                        return [];
                    }
                    const response = await fetch(url);
                    if (!response.ok) return [];
                    const data = await response.json();
                    return data.success ? data.downloads : [];
                } catch (error) {
                    console.error('Error fetching download links:', error);
                    return [];
                }
            }
        };

        const storageService = {
            API_KEY_NAME: 'tmdb_api_key',
            USER_KEY_NAME: 'brokieflix_user',
            GENRES_KEY_NAME: 'brokieflix_genres',
            getUser: () => JSON.parse(localStorage.getItem(storageService.USER_KEY_NAME)),
            setUser: (user) => localStorage.setItem(storageService.USER_KEY_NAME, JSON.stringify(user)),
            getContinueWatchingKey: (mode) => `brokieflix_continue_watching_${mode}`,
            getApiKey: () => localStorage.getItem(storageService.API_KEY_NAME),
            setApiKey: (key) => localStorage.setItem(storageService.API_KEY_NAME, key),
            getSelectedGenres: () => JSON.parse(localStorage.getItem(storageService.GENRES_KEY_NAME) || '{}'),
            setSelectedGenres: (genres) => localStorage.setItem(storageService.GENRES_KEY_NAME, JSON.stringify(genres)),
            getContinueWatching(mode) {
                try {
                    const data = localStorage.getItem(this.getContinueWatchingKey(mode));
                    return data ? JSON.parse(data) : [];
                } catch (e) { return []; }
            },
            addToContinueWatching(item, mode) {
                try {
                    const current = this.getContinueWatching(mode);
                    const newItem = { ...item, timestamp: Date.now() };
                    const filtered = current.filter(i => !(i.id === item.id && i.type === item.type && i.season === item.season && i.episode === item.episode));
                    const updated = [newItem, ...filtered].slice(0, 20);
                    localStorage.setItem(this.getContinueWatchingKey(mode), JSON.stringify(updated));
                } catch (e) { console.error("Failed to save to local storage", e) }
            },
            removeFromContinueWatching(id, type, mode) {
                let current = this.getContinueWatching(mode);
                if (type === 'tv') {
                    current = current.filter(item => !(item.type === 'tv' && item.id === id));
                } else {
                    current = current.filter(item => !(item.id === id && item.type === type));
                }
                localStorage.setItem(this.getContinueWatchingKey(mode), JSON.stringify(current));
                renderApp();
            },
            clearContinueWatching(mode) {
                localStorage.removeItem(this.getContinueWatchingKey(mode));
            },
            logout() {
                localStorage.removeItem(this.API_KEY_NAME);
                localStorage.removeItem(this.USER_KEY_NAME);
                localStorage.removeItem(this.GENRES_KEY_NAME);
                localStorage.removeItem(this.getContinueWatchingKey('all'));
                localStorage.removeItem(this.getContinueWatchingKey('kids'));
                localStorage.removeItem(this.getContinueWatchingKey('anime'));
                location.reload();
            }
        };
        
        // --- UI COMPONENTS & PAGES ---
        const render = (template, containerId = 'app') => { document.getElementById(containerId).innerHTML = template; };

        const Navbar = (searchQuery = '') => {
            const user = storageService.getUser();
            return `
            <nav class="fixed top-0 left-0 right-0 z-50 glass">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <a href="#" class="text-2xl font-bold text-[hsl(var(--primary))] hover:text-[hsl(var(--primary-glow))] transition-colors duration-300">BrokieFlix</a>
                        <div class="flex items-center gap-2 md:gap-3">
                            <div class="flex items-center bg-[hsl(var(--surface))] border border-[hsl(var(--border))] rounded-full">
                                <div id="toggle-switch" class="toggle-switch-container !border-none !p-0">
                                    <div class="toggle-switch-slider"></div>
                                    <div class="toggle-switch-option" data-mode="all">All</div>
                                    <div class="toggle-switch-option" data-mode="kids">Kids</div>
                                    <div class="toggle-switch-option" data-mode="anime">Anime</div>
                                </div>
                                <div id="genre-picker-container" class="relative"></div>
                            </div>
                            <button id="surprise-me-btn" class="p-2.5 bg-[hsl(var(--surface))] border border-[hsl(var(--border))] rounded-full text-muted-foreground hover:text-[hsl(var(--primary))] hover:border-[hsl(var(--primary))] transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 8 4 4-4 4"/><path d="m6 8-4 4 4 4"/><path d="M14.5 4l-5 16"/></svg>
                            </button>
                            <form id="search-form" class="relative">
                                <input id="search-input" value="${searchQuery}" type="text" placeholder="Search..." class="w-32 md:w-48 bg-[hsl(var(--surface))] border border-[hsl(var(--border))] rounded-full pl-10 pr-4 py-2 text-sm text-foreground placeholder-muted-foreground focus:outline-none focus:border-[hsl(var(--primary))] focus:ring-1 focus:ring-[hsl(var(--primary))] transition-all duration-300">
                                <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                            </form>
                             <a href="#settings" class="flex-shrink-0">
                                <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center font-bold text-primary-foreground text-lg">${user ? user.username.charAt(0).toUpperCase() : ''}</div>
                             </a>
                        </div>
                    </div>
                </div>
            </nav>
        `;
        }
        
        const HeroSection = (content) => {
            if (!content) return `<div class="relative h-[70vh] md:h-[85vh] shimmer"></div>`;
            const isMovie = 'title' in content;
            const title = isMovie ? content.title : content.name;
            const releaseDate = isMovie ? content.release_date : content.first_air_date;
            const year = releaseDate ? new Date(releaseDate).getFullYear() : '';
            const backdropUrl = tmdbService.getBackdropUrl(content.backdrop_path, 'w1280');
            const playLink = isMovie ? `#player/movie/${content.id}` : `#tv/${content.id}/episodes`;

            return `
                <div class="relative h-[70vh] md:h-[85vh] overflow-hidden">
                    <div class="absolute inset-0 bg-cover bg-center bg-no-repeat transition-all duration-1000 ease-in-out" style="background-image: url(${backdropUrl});"></div>
                    <div class="absolute inset-0 bg-gradient-to-r from-[hsl(var(--background))] via-[hsl(var(--background))/0.8] to-transparent"></div>
                    <div class="absolute inset-0 bg-gradient-to-t from-[hsl(var(--background))] to-transparent"></div>
                    <div class="relative h-full flex items-center">
                        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="max-w-2xl space-y-6 fade-in">
                                <h1 class="text-4xl md:text-6xl lg:text-7xl font-bold text-foreground leading-tight">${title}</h1>
                                <div class="flex items-center space-x-4 text-muted-foreground">
                                    <div class="flex items-center space-x-1">
                                        <svg class="w-4 h-4 text-yellow-500 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                        <span>${content.vote_average.toFixed(1)}</span>
                                    </div>
                                    ${year ? `<span>${year}</span>` : ''}
                                    <span class="px-2 py-1 bg-[hsl(var(--primary)/0.2)] text-[hsl(var(--primary))] rounded text-sm font-medium">${isMovie ? 'Movie' : 'TV Series'}</span>
                                </div>
                                <p class="text-lg md:text-xl text-foreground/90 leading-relaxed" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">${content.overview}</p>
                                <div class="flex flex-col sm:flex-row gap-4">
                                    <a href="${playLink}" class="btn-primary flex items-center justify-center space-x-2 text-lg rounded-lg px-6 py-3 font-semibold">
                                        <svg class="w-5 h-5 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                        <span>${isMovie ? 'Play Now' : 'Episodes'}</span>
                                    </a>
                                    <a href="#info/${isMovie ? 'movie' : 'tv'}/${content.id}" class="btn-secondary flex items-center justify-center space-x-2 text-lg border border-border rounded-lg px-6 py-3 font-semibold">
                                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                                        <span>More Info</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const ContentRow = ({ title, items, isLoading = false, id = '' }) => {
            if (isLoading) {
                return `
                    <div class="space-y-4 animate-pulse" ${id ? `id="${id}"` : ''}>
                        <div class="h-8 w-1/4 bg-surface-elevated rounded-md mx-4 sm:mx-6 lg:mx-8"></div>
                        <div class="relative px-4 sm:px-6 lg:mx-8">
                            <div class="flex space-x-4 overflow-hidden">
                                ${Array(6).fill('').map(() => `
                                    <div class="flex-shrink-0 w-40 md:w-48">
                                        <div class="shimmer aspect-[2/3] rounded-lg"></div>
                                        <div class="mt-2 h-4 shimmer rounded w-full"></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>`;
            }
            if (!items || items.length === 0) return '';
            
            return `
                <div class="space-y-4" ${id ? `id="${id}"` : ''}>
                    <h2 class="text-2xl font-bold text-foreground px-4 sm:px-6 lg:px-8">${title}</h2>
                    <div class="relative group">
                         <div class="flex space-x-4 overflow-x-auto custom-scrollbar px-4 sm:px-6 lg:px-8 py-2">
                            ${items.map(item => {
                                const isMovie = 'title' in item || item.media_type === 'movie';
                                const itemTitle = isMovie ? (item.title || item.original_title) : (item.name || item.original_name);
                                const posterUrl = tmdbService.getImageUrl(item.poster_path, 'w300');
                                const mediaType = item.media_type || (isMovie ? 'movie' : 'tv');
                                return `
                                    <a href="#info/${mediaType}/${item.id}" class="flex-shrink-0 w-40 md:w-48 group/item hover-scale">
                                        <div class="relative overflow-hidden rounded-lg">
                                            <img src="${posterUrl}" alt="${itemTitle}" class="w-full aspect-[2/3] object-cover bg-surface" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/300x450/0a0e1a/e0e0e0?text=Error';">
                                            <div class="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 group-hover/item:opacity-100 transition-opacity duration-300">
                                                <div class="p-3 bg-[hsl(var(--primary)/0.8)] backdrop-blur-sm rounded-full">
                                                     <svg class="w-5 h-5 fill-current text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                                </div>
                                            </div>
                                        </div>
                                        <h3 class="mt-2 text-foreground font-semibold text-sm line-clamp-2 group-hover/item:text-[hsl(var(--primary))] transition-colors duration-300">${itemTitle}</h3>
                                    </a>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        };

        const ContinueWatchingRow = () => {
            const continueWatchingItems = storageService.getContinueWatching(appState.mode);
            
            const groupedShows = continueWatchingItems.reduce((acc, item) => {
                const key = item.type === 'tv' ? `tv-${item.id}` : `movie-${item.id}`;
                if (!acc[key]) {
                    acc[key] = { ...item, isGroup: item.type === 'tv', episodes: item.type === 'tv' ? [item] : [] };
                } else if (item.type === 'tv') {
                    acc[key].episodes.push(item);
                    if (item.timestamp > acc[key].timestamp) {
                       acc[key] = { ...acc[key], ...item };
                    }
                }
                return acc;
            }, {});

            const items = Object.values(groupedShows).sort((a, b) => b.timestamp - a.timestamp);

            if (items.length === 0) return '';
            
            return `
                <div class="space-y-4">
                    <div class="flex items-center justify-between px-4 sm:px-6 lg:px-8">
                        <h2 class="text-2xl font-bold text-foreground">Continue Watching</h2>
                        <button id="clear-watching-btn" class="text-sm text-muted-foreground hover:text-[hsl(var(--primary))] transition-colors">Clear All</button>
                    </div>
                    <div class="relative group">
                         <div class="flex space-x-4 overflow-x-auto custom-scrollbar px-4 sm:px-6 lg:px-8 py-2">
                            ${items.map(item => {
                                const posterUrl = tmdbService.getImageUrl(item.poster_path, 'w300');
                                const playLink = item.type === 'tv' ? `#player/tv/${item.id}/${item.season}/${item.episode}` : `#player/movie/${item.id}`;
                                const titleText = item.type === 'tv' ? `${item.title}` : item.title;
                                const subText = item.type === 'tv' ? `<p class="text-xs text-muted-foreground">Last: S${item.season} E${item.episode}</p>` : '';

                                return `
                                    <div class="flex-shrink-0 w-64 group/item">
                                        <div class="relative bg-surface rounded-lg overflow-hidden glow-border flex items-center h-28">
                                            <a href="${playLink}" class="flex-shrink-0">
                                                <img src="${posterUrl}" alt="${item.title}" class="w-20 h-28 object-cover" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/200x300/0a0e1a/e0e0e0?text=Error';">
                                            </a>
                                            <div class="p-3 flex-1">
                                                <a href="${playLink}" class="font-semibold text-foreground line-clamp-2 group-hover/item:text-[hsl(var(--primary))] transition-colors">${titleText}</a>
                                                ${subText}
                                            </div>
                                            <button data-id="${item.id}" data-type="${item.type}" class="remove-watching-btn absolute top-2 right-2 p-1.5 bg-black/50 rounded-full text-white hover:bg-red-600 transition-all opacity-0 group-hover/item:opacity-100">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        };

        const HomePage = async () => {
            render(`
                ${Navbar()}
                <main class="pt-16 page-refresh-in">
                    <div class="relative h-[70vh] md:h-[85vh] shimmer"></div>
                    <div class="space-y-12 pb-12 mt-12">
                        <div class="shimmer h-48 w-full"></div>
                    </div>
                </main>
            `);
             attachNavEvents();
            
            let heroContentPromise;
            const animeKeyword = '210024';
            switch(appState.mode) {
                case 'kids':
                    heroContentPromise = tmdbService.discover('movie', { with_genres: '10751,16', sort_by: 'popularity.desc', without_keywords: animeKeyword });
                    break;
                case 'anime':
                    heroContentPromise = tmdbService.discover('tv', { with_genres: '16', with_keywords: animeKeyword, sort_by: 'popularity.desc' });
                    break;
                default:
                    heroContentPromise = tmdbService.getTrending('all', 'day');
            }

            const heroData = await heroContentPromise;
            const heroContent = heroData.results.find(item => item.backdrop_path) || heroData.results[0];

            render(`
                ${Navbar()}
                <main class="pt-16">
                    <div id="hero"></div>
                    <div id="content-rows" class="space-y-12 pb-12 mt-12"></div>
                </main>
            `);
            
            document.getElementById('hero').innerHTML = HeroSection(heroContent);
            
            const rowsContainer = document.getElementById('content-rows');
            rowsContainer.innerHTML = ContinueWatchingRow();

            let rows = [];
            switch (appState.mode) {
                case 'kids':
                    rows = [
                        { title: "Popular Kids Movies", promise: tmdbService.discover('movie', { with_genres: '10751,16', certification_country: 'US', 'certification.lte': 'PG', without_keywords: animeKeyword }) },
                        { title: "Popular Kids TV Shows", promise: tmdbService.discover('tv', { with_genres: '10751,16', 'air_date.gte': '2000-01-01', 'vote_average.gte': 6, without_keywords: animeKeyword }) },
                    ];
                    break;
                case 'anime':
                    rows = [
                        { title: "Top Airing Anime", promise: tmdbService.discover('tv', { with_genres: '16', with_keywords: '210024|287501', sort_by: 'popularity.desc' }) },
                        { title: "Popular Anime Movies", promise: tmdbService.discover('movie', { with_genres: '16', with_keywords: '210024|287501', sort_by: 'popularity.desc' }) },
                    ];
                    break;
                default: // 'all'
                    rows = [
                        { title: "Trending Now", promise: tmdbService.getTrending('all', 'day') },
                        { title: "Popular Movies", promise: tmdbService.getPopularMovies() },
                        { title: "Popular TV Shows", promise: tmdbService.getPopularTVShows() },
                    ];
            }

            for (const row of rows) {
                const rowEl = document.createElement('div');
                rowsContainer.appendChild(rowEl);
                rowEl.innerHTML = ContentRow({ title: row.title, isLoading: true });
                const data = await row.promise;
                rowEl.innerHTML = ContentRow({ title: row.title, items: data.results });
            }

            // Render selected genre rows
            const selectedGenres = storageService.getSelectedGenres();
            for (const [id, name] of Object.entries(selectedGenres)) {
                 if (appState.mode !== 'all') continue;
                const genreRowContainer = document.createElement('div');
                genreRowContainer.id = `genre-row-${id}`;
                rowsContainer.appendChild(genreRowContainer);
                genreRowContainer.innerHTML = ContentRow({ title: name, isLoading: true });
                const data = await tmdbService.discover('movie', { with_genres: id, sort_by: 'popularity.desc' });
                genreRowContainer.innerHTML = ContentRow({ title: name, items: data.results });
            }


            attachNavEvents();
        };

        const SearchPage = async (query) => {
            render(`
                ${Navbar(decodeURIComponent(query))}
                <main class="pt-24 container mx-auto px-4 sm:px-6 lg:px-8">
                    <h1 class="text-3xl font-bold mb-8">Searching for "${decodeURIComponent(query)}"...</h1>
                    ${ContentRow({ title: "Results", isLoading: true })}
                </main>
            `);
            attachNavEvents(decodeURIComponent(query));
            const results = await tmdbService.searchMulti(query);
            
            const initialItems = results.results.filter(item => (item.media_type === 'movie' || item.media_type === 'tv') && item.poster_path);
            let contentItems = [];

            switch (appState.mode) {
                case 'kids':
                    const kidsGenreIds = [16, 10751, 10762]; // Animation, Family, Kids
                    contentItems = initialItems.filter(item => item.genre_ids && item.genre_ids.some(id => kidsGenreIds.includes(id)));
                    break;
                case 'anime':
                    const animeGenreId = 16; // Animation
                    contentItems = initialItems.filter(item => item.genre_ids && item.genre_ids.includes(animeGenreId));
                    break;
                default: // 'all'
                    contentItems = initialItems;
                    break;
            }

            document.querySelector('main').innerHTML = `
                <h1 class="text-3xl font-bold mb-8">Results for "${decodeURIComponent(query)}"</h1>
                ${contentItems.length > 0 ? ContentRow({ title: "", items: contentItems }) : `<p class="text-muted-foreground text-center py-16">No results found for this category.</p>`}
            `;
            attachNavEvents(decodeURIComponent(query));
        };

        const InfoPage = async (type, id) => {
            render(`${Navbar()}<div class="min-h-screen bg-background pt-16 shimmer"></div>`);
            const data = type === 'movie' ? await tmdbService.getMovieDetails(id) : await tmdbService.getTVShowDetails(id);
            const isMovie = 'title' in data;
            const title = isMovie ? data.title : data.name;
            const playLink = isMovie ? `#player/movie/${id}` : `#tv/${id}/episodes`;

            const playButtonHTML = 
                `<a href="${playLink}" class="btn-primary inline-flex items-center justify-center space-x-2 text-lg rounded-lg px-6 py-3 font-semibold">
                    ${isMovie 
                        ? `<svg class="w-5 h-5 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg><span>Play Now</span>`
                        : `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16M4 12h16M4 18h16"/></svg><span>Episodes & Seasons</span>`
                    }
                 </a>`;

            render(`
                ${Navbar()}
                <main class="pt-16">
                    <div class="relative h-[60vh] md:h-[70vh]">
                        <div class="absolute inset-0 bg-cover bg-center" style="background-image: url(${tmdbService.getBackdropUrl(data.backdrop_path)})"></div>
                        <div class="absolute inset-0 bg-gradient-to-t from-background via-background/80 to-transparent"></div>
                         <div class="relative h-full flex items-end container mx-auto px-4 sm:px-6 lg:px-8 pb-8">
                            <div class="flex flex-col md:flex-row gap-8 items-end">
                                <img src="${tmdbService.getImageUrl(data.poster_path)}" alt="${title}" class="w-48 md:w-64 aspect-[2/3] object-cover rounded-lg shadow-xl -mb-16 md:-mb-24 glow-border">
                                <div class="space-y-4">
                                    <h1 class="text-4xl md:text-6xl font-bold text-foreground">${title}</h1>
                                    ${playButtonHTML}
                                </div>
                            </div>
                         </div>
                    </div>
                     <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:pt-32">
                        <p class="max-w-3xl text-foreground/90 leading-relaxed mb-8">${data.overview}</p>
                        ${data.recommendations && data.recommendations.results.length > 0 ? ContentRow({ title: "More Like This", items: data.recommendations.results }) : ''}
                     </div>
                </main>
            `);
            attachNavEvents();
        };
        
        const EpisodesPage = async (id) => {
            render(`${Navbar()}<div class="min-h-screen bg-background pt-16 shimmer"></div>`);
            const showData = await tmdbService.getTVShowDetails(id);
            
            render(`
                ${Navbar()}
                <main class="pt-16">
                    <div class="relative h-[50vh] min-h-[300px]">
                        <div class="absolute inset-0 bg-cover bg-center" style="background-image: url(${tmdbService.getBackdropUrl(showData.backdrop_path)})"></div>
                        <div class="absolute inset-0 bg-gradient-to-t from-background via-background/70 to-transparent"></div>
                        <div class="relative h-full flex flex-col justify-end container mx-auto px-4 sm:px-6 lg:px-8 pb-8">
                             <h1 class="text-4xl md:text-5xl font-bold text-foreground">${showData.name}</h1>
                             <p class="text-lg text-muted-foreground mt-2">Seasons & Episodes</p>
                        </div>
                    </div>
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div id="season-selector-container" class="relative w-full max-w-xs mb-6"></div>
                        <div id="episodes-list" class="flex flex-col gap-4">
                            <div class="shimmer h-40 rounded-lg"></div>
                            <div class="shimmer h-40 rounded-lg"></div>
                            <div class="shimmer h-40 rounded-lg"></div>
                        </div>
                    </div>
                </main>
            `);
            attachNavEvents();

            const seasonSelectorContainer = document.getElementById('season-selector-container');
            const seasons = showData.seasons.filter(s => s.season_number > 0 && s.episode_count > 0);
            
            if (seasonSelectorContainer) {
                seasonSelectorContainer.innerHTML = `
                    <button id="season-selector-trigger" class="w-full flex items-center justify-between p-3 bg-surface-elevated border border-border text-foreground rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[hsl(var(--background))] focus:ring-[hsl(var(--primary))] transition-all">
                        <span id="season-selector-label"></span>
                        <svg class="w-5 h-5 text-muted-foreground transition-transform" id="season-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                    </button>
                    <div id="season-selector-panel" class="hidden absolute top-full mt-2 w-full bg-[hsl(var(--surface-elevated))] border border-[hsl(var(--border))] rounded-md shadow-lg z-50">
                        <div class="p-2 space-y-1">
                            ${seasons.map(s => `<button class="season-option w-full text-left px-3 py-2 text-sm rounded hover:bg-[hsl(var(--surface))] transition-colors" data-season-number="${s.season_number}" data-season-name="${s.name} (${s.episode_count} episodes)">${s.name} (${s.episode_count} episodes)</button>`).join('')}
                        </div>
                    </div>
                `;
            }

            const fetchAndRenderEpisodes = async (seasonNumber) => {
                const episodesList = document.getElementById('episodes-list');
                episodesList.innerHTML = Array(10).fill('').map(() => `<div class="shimmer h-40 rounded-lg"></div>`).join('');
                
                const seasonData = await tmdbService.getTVShowSeason(showData.id, seasonNumber);
                episodesList.innerHTML = seasonData.episodes.map(ep => `
                    <a href="#player/tv/${showData.id}/${seasonNumber}/${ep.episode_number}" class="episode-item flex items-center gap-4 md:gap-6 p-4 rounded-lg hover:bg-[hsl(var(--surface))]-elevated group transition-all duration-300">
                        <div class="text-xl font-bold text-muted-foreground w-8 text-center flex-shrink-0">${ep.episode_number}</div>
                        <div class="relative w-40 md:w-48 h-24 md:h-28 flex-shrink-0">
                           <img src="${tmdbService.getImageUrl(ep.still_path, 'w300')}" class="w-full h-full object-cover rounded-md bg-surface" onerror="this.onerror=null;this.src='https://placehold.co/300x169/0a0e1a/e0e0e0?text=No+Image';">
                           <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                               <svg class="w-10 h-10 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                           </div>
                        </div>
                        <div class="flex-1">
                           <div class="flex justify-between items-start">
                               <h4 class="font-bold text-base md:text-lg text-foreground group-hover:text-[hsl(var(--primary))]">${ep.name}</h4>
                               <span class="text-sm text-muted-foreground flex-shrink-0 ml-4">${ep.runtime ? `${ep.runtime}m` : ''}</span>
                           </div>
                           <p class="text-sm text-muted-foreground line-clamp-2 md:line-clamp-3 mt-2">${ep.overview || 'No description available.'}</p>
                        </div>
                    </a>
                `).join('');
            };
            
            const trigger = document.getElementById('season-selector-trigger');
            const panel = document.getElementById('season-selector-panel');
            const label = document.getElementById('season-selector-label');
            const chevron = document.getElementById('season-chevron');

            if(trigger && panel && label && chevron) {
                // Set initial label
                if (seasons.length > 0) {
                    const firstSeason = seasons[0];
                    label.textContent = `${firstSeason.name} (${firstSeason.episode_count} episodes)`;
                } else {
                    label.textContent = 'No Seasons Available';
                }

                trigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isHidden = panel.classList.contains('hidden');
                    panel.classList.toggle('hidden', !isHidden);
                    chevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
                });

                document.querySelectorAll('.season-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const seasonNumber = option.dataset.seasonNumber;
                        const seasonName = option.dataset.seasonName;
                        label.textContent = seasonName;
                        panel.classList.add('hidden');
                        chevron.style.transform = 'rotate(0deg)';
                        fetchAndRenderEpisodes(seasonNumber);
                    });
                });

                window.addEventListener('click', (e) => {
                    if (seasonSelectorContainer && !seasonSelectorContainer.contains(e.target)) {
                        panel.classList.add('hidden');
                        chevron.style.transform = 'rotate(0deg)';
                    }
                });

                if (seasons.length > 0) {
                    fetchAndRenderEpisodes(seasons[0].season_number);
                } else {
                    document.getElementById('episodes-list').innerHTML = `<p class="text-muted-foreground">No seasons available for this show.</p>`
                }
            }
        };
        
        const PlayerPage = async (type, id, season = 1, episode = 1) => {
            render(`<div class="h-screen w-screen bg-black flex items-center justify-center"><div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-[hsl(var(--primary))]"></div></div>`);
            
            const contentDetails = type === 'tv' ? await tmdbService.getTVShowDetails(id) : await tmdbService.getMovieDetails(id);
            const isAnime = contentDetails.keywords?.results?.some(k => k.name === 'anime') || contentDetails.genres?.some(g => g.name === 'Animation');
            const title = contentDetails.title || contentDetails.name;

            if (contentDetails) {
                 storageService.addToContinueWatching({ 
                     id: parseInt(id), 
                     type, 
                     season, 
                     episode, 
                     title: title, 
                     poster_path: contentDetails.poster_path 
                 }, appState.mode);
            }
            
            let sources = [];
            if (isAnime) {
                 sources = await streamingService.getAnimeSources(title, episode);
            }
            // Add other sources as fallbacks
            const otherSources = type === 'movie' ? streamingService.getMovieSources(id) : streamingService.getTVSources(id, season, episode);
            sources.push(...otherSources);

            const seasonData = type === 'tv' ? await tmdbService.getTVShowSeason(id, season) : null;
            const downloadLinks = await streamingService.getDownloadLinks(id, type, season, episode);

            const currentEpisodeIndex = seasonData ? seasonData.episodes.findIndex(e => e.episode_number == episode) : -1;
            const nextEpisode = seasonData && currentEpisodeIndex > -1 && currentEpisodeIndex < seasonData.episodes.length - 1 ? seasonData.episodes[currentEpisodeIndex + 1] : null;

            render(`
                <div class="h-screen w-screen bg-black flex flex-col">
                    <div class="p-2 bg-black flex items-center justify-between z-10">
                         <a href="#info/${type}/${id}" class="text-white hover:text-[hsl(var(--primary))] transition-colors text-sm flex items-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg> Back
                         </a>
                         <div class="flex items-center gap-4">
                             <div id="sources-container" class="relative"></div>
                             <div id="download-container" class="relative"></div>
                             ${nextEpisode ? `<a href="#player/tv/${id}/${season}/${nextEpisode.episode_number}" class="btn-primary text-sm px-4 py-2 rounded-md flex items-center gap-2">Next Ep <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></a>` : ''}
                         </div>
                    </div>
                    <iframe id="player-iframe" src="${sources[0]?.url || ''}" class="w-full h-full flex-1 border-0" allowfullscreen></iframe>
                </div>
            `);
            
            // Source Dropdown
            const sourcesContainer = document.getElementById('sources-container');
            if(sources.length > 0 && sources[0].url) {
                sourcesContainer.innerHTML = `
                    <button id="sources-btn" class="source-btn px-3 py-1 text-xs rounded bg-gray-700 text-white flex items-center gap-1">
                        <span>Source: ${sources[0].name}</span>
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                    <div id="sources-dropdown" class="absolute top-full right-0 mt-2 w-48 bg-surface border border-border rounded-lg shadow-xl hidden">
                        <div class="p-1">${sources.map(source => `<button class="source-option w-full text-left px-3 py-2 text-xs rounded hover:bg-[hsl(var(--surface))]-elevated" data-url="${source.url}" data-name="${source.name}">${source.name}</button>`).join('')}</div>
                    </div>
                `;
                 document.getElementById('sources-btn').addEventListener('click', () => document.getElementById('sources-dropdown').classList.toggle('hidden'));
                 document.querySelectorAll('.source-option').forEach(button => {
                     button.addEventListener('click', e => {
                         const url = e.target.dataset.url;
                         const name = e.target.dataset.name;
                         document.getElementById('player-iframe').src = url;
                         document.querySelector('#sources-btn span').textContent = `Source: ${name}`;
                         document.getElementById('sources-dropdown').classList.add('hidden');
                     });
                 });
            }

            // Download Dropdown
            const downloadContainer = document.getElementById('download-container');
            if (downloadLinks.length > 0) {
              downloadContainer.innerHTML = `
                <button id="download-btn" class="text-sm flex items-center gap-2 hover:text-[hsl(var(--primary))] text-white">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                </button>
                <div id="download-dropdown" class="absolute top-full right-0 mt-2 w-56 bg-surface border border-border rounded-lg shadow-xl hidden">
                  <div class="p-2 space-y-1">${downloadLinks.map(link => `<a href="${link.url}" target="_blank" rel="noopener noreferrer" class="block px-3 py-2 text-xs text-foreground hover:bg-[hsl(var(--surface))]-elevated rounded-md"><div class="flex justify-between"><span>${link.quality}</span><span class="text-muted-foreground">${link.size || ''}</span></div></a>`).join('')}</div>
                </div>
              `;
              document.getElementById('download-btn').addEventListener('click', () => document.getElementById('download-dropdown').classList.toggle('hidden'));
            }
        };

        const SettingsPage = () => {
            const user = storageService.getUser();
            const apiKey = storageService.getApiKey();

            const historyAll = storageService.getContinueWatching('all');
            const historyKids = storageService.getContinueWatching('kids');
            const historyAnime = storageService.getContinueWatching('anime');
            
            const combinedHistory = [...historyAll, ...historyKids, ...historyAnime];
            const uniqueHistoryMap = new Map();
            combinedHistory.forEach(item => {
                const key = `${item.type}-${item.id}-${item.season || 0}-${item.episode || 0}`;
                if (!uniqueHistoryMap.has(key) || uniqueHistoryMap.get(key).timestamp < item.timestamp) {
                    uniqueHistoryMap.set(key, item);
                }
            });
            const continueWatchingItems = Array.from(uniqueHistoryMap.values()).sort((a, b) => b.timestamp - a.timestamp);

            render(`
                ${Navbar()}
                <main class="pt-24 container mx-auto px-4 sm:px-6 lg:px-8">
                    <h1 class="text-4xl font-bold mb-8">Settings</h1>
                    <div class="space-y-12">
                         <div class="bg-surface-elevated p-6 rounded-lg">
                            <h2 class="text-2xl font-semibold mb-4">Profile</h2>
                            <div class="flex items-center space-x-4">
                               <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center font-bold text-primary-foreground text-3xl">${user.username.charAt(0).toUpperCase()}</div>
                               <div>
                                  <p class="text-xl font-bold">${user.username}</p>
                                  <p class="text-muted-foreground">Welcome to BrokieFlix!</p>
                               </div>
                            </div>
                        </div>

                        <div class="bg-surface-elevated p-6 rounded-lg">
                            <h2 class="text-2xl font-semibold mb-4">TMDB API Key</h2>
                            <input id="api-key-input" type="text" class="w-full bg-surface border border-border rounded-md p-2 mb-4" value="${apiKey}">
                            <button id="save-api-key-btn" class="btn-primary px-6 py-2 rounded-lg font-semibold">Save Key</button>
                        </div>
                        
                        <div class="bg-surface-elevated p-6 rounded-lg">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-2xl font-semibold">Full Watch History</h2>
                                <button id="clear-history-btn" class="btn-secondary text-sm px-4 py-2 rounded-lg">Clear All History</button>
                            </div>
                            <div class="max-h-96 overflow-y-auto space-y-3 custom-scrollbar pr-2">
                                ${continueWatchingItems.length > 0 ? continueWatchingItems.map(item => `
                                    <div class="flex items-center bg-surface p-2 rounded-md">
                                        <img src="${tmdbService.getImageUrl(item.poster_path, 'w300')}" class="w-12 h-16 object-cover rounded-md mr-4">
                                        <div class="flex-grow">
                                            <p class="font-semibold">${item.title}</p>
                                            ${item.type === 'tv' ? `<p class="text-xs text-muted-foreground">S${item.season} E${item.episode}</p>`: ''}
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-muted-foreground">No watch history yet.</p>'}
                            </div>
                        </div>

                         <div class="bg-surface-elevated p-6 rounded-lg">
                            <h2 class="text-2xl font-semibold mb-4">Account</h2>
                            <button id="logout-btn" class="bg-red-600/20 text-red-400 hover:bg-red-600/40 w-full py-3 rounded-lg font-semibold transition-colors">Log Out & Clear All Data</button>
                         </div>
                    </div>
                </main>
            `);
            attachNavEvents(); // Re-attach nav events, especially for the settings page buttons
        };
        
        // --- ROUTER & APP LOGIC ---
        const appState = {
            mode: localStorage.getItem('brokieflix_mode') || 'all',
            genres: [
                {id: 35, name: 'Comedy'}, {id: 27, name: 'Horror'}, {id: 10749, name: 'Romance'},
                {id: 28, name: 'Action'}, {id: 12, name: 'Adventure'}, {id: 878, name: 'Sci-Fi'},
                {id: 53, name: 'Thriller'}, {id: 80, name: 'Crime'}, {id: 99, name: 'Documentary'}
            ]
        };

        const routes = {
            '': HomePage,
            '#search/:query': SearchPage,
            '#info/:type/:id': InfoPage,
            '#tv/:id/episodes': EpisodesPage,
            '#player/:type/:id': PlayerPage,
            '#player/:type/:id/:season/:episode': PlayerPage,
            '#settings': SettingsPage,
        };

        const renderApp = () => {
            const path = location.hash.split('?')[0] || '#';
            
            const clearApiKeyBtn = document.getElementById('clear-api-key-btn');
            if (clearApiKeyBtn) {
                 if(path === '' || path === '#') {
                     clearApiKeyBtn.classList.remove('hidden');
                 } else {
                     clearApiKeyBtn.classList.add('hidden');
                 }
            }
            
            let params = {};
            const potentialRoute = Object.keys(routes).find(route => {
                const routeParts = route.split('/');
                const pathParts = path.split('/');
                if(routeParts.length !== pathParts.length) return false;
                
                return routeParts.every((part, i) => {
                    if (part.startsWith(':')) {
                        params[part.substring(1)] = decodeURIComponent(pathParts[i]);
                        return true;
                    }
                    return part === pathParts[i];
                });
            });
            const routeHandler = routes[potentialRoute] || HomePage;
            routeHandler(...Object.values(params));
        };
        
       const attachNavEvents = (searchQuery = '') => {
            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            if (searchInput) searchInput.value = searchQuery;

            searchForm?.addEventListener('submit', (e) => {
                e.preventDefault();
                const query = searchInput.value.trim();
                if (query) location.hash = `#search/${encodeURIComponent(query)}`;
            });

            document.getElementById('clear-watching-btn')?.addEventListener('click', () => storageService.clearContinueWatching(appState.mode));

            document.querySelectorAll('.remove-watching-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const { id, type } = e.currentTarget.dataset;
                    storageService.removeFromContinueWatching(parseInt(id), type, appState.mode);
                });
            });
            
            document.getElementById('surprise-me-btn')?.addEventListener('click', showSurpriseModal);

            const toggleSwitch = document.getElementById('toggle-switch');
            const slider = toggleSwitch?.querySelector('.toggle-switch-slider');
            const options = toggleSwitch?.querySelectorAll('.toggle-switch-option');

            const setActiveToggle = (mode) => {
                appState.mode = mode;
                localStorage.setItem('brokieflix_mode', mode);
                const genreContainer = document.getElementById('genre-picker-container');

                if (genreContainer) {
                    if (mode === 'all') {
                        genreContainer.style.display = 'block';
                    } else {
                        genreContainer.style.display = 'none';
                    }
                }

                options?.forEach(opt => {
                    const isActive = opt.dataset.mode === mode;
                    opt.classList.toggle('active', isActive);
                    if (isActive) {
                        slider.style.width = `${opt.offsetWidth}px`;
                        slider.style.transform = `translateX(${opt.offsetLeft - 4}px)`;
                    }
                });
            };
            
            options?.forEach(option => {
                option.addEventListener('click', () => {
                    if (appState.mode === option.dataset.mode) return;

                    const appContainer = document.getElementById('app');
                    appContainer.classList.add('page-refresh-out');
                    
                    appContainer.addEventListener('animationend', () => {
                        appContainer.classList.remove('page-refresh-out');
                        setActiveToggle(option.dataset.mode);
                        location.hash = '';
                        renderApp();
                    }, { once: true });
                });
            });

            if (toggleSwitch) {
                // Initial setup
                setTimeout(() => setActiveToggle(appState.mode), 100);
            }
            
            // Genre Picker
            const genreContainer = document.getElementById('genre-picker-container');
            if (genreContainer) {
                 const selectedGenres = storageService.getSelectedGenres();
                 genreContainer.innerHTML = `
                    <button id="genre-picker-btn" class="pr-3 pl-2 py-2.5 text-muted-foreground hover:text-[hsl(var(--primary))] transition-colors border-l border-[hsl(var(--border))]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    </button>
                    <div id="genre-dropdown" class="hidden absolute top-full right-0 mt-4 w-64 bg-surface-elevated border border-border rounded-lg shadow-xl">
                        <div class="p-2 text-sm font-semibold text-foreground border-b border-border">Add sections to homepage</div>
                        <div class="p-2 grid grid-cols-2 gap-2">
                           ${appState.genres.map(g => `
                                <label class="flex items-center space-x-2 p-2 rounded-md hover:bg-surface transition-colors cursor-pointer">
                                    <input type="checkbox" data-genre-id="${g.id}" data-genre-name="${g.name}" class="genre-checkbox accent-[hsl(var(--primary))] w-4 h-4" ${selectedGenres[g.id] ? 'checked' : ''}>
                                    <span class="text-sm">${g.name}</span>
                                </label>
                           `).join('')}
                        </div>
                    </div>
                 `;
                document.getElementById('genre-picker-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('genre-dropdown').classList.toggle('hidden');
                });
                document.querySelectorAll('.genre-checkbox').forEach(box => box.addEventListener('change', handleGenreChange));
            }
            
            // Settings Page specific events
            document.getElementById('save-api-key-btn')?.addEventListener('click', () => {
                const key = document.getElementById('api-key-input').value.trim();
                if (key) {
                    storageService.setApiKey(key);
                    alert('API Key Saved!'); // A simple notification
                }
            });
            document.getElementById('clear-history-btn')?.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear your entire watch history? This cannot be undone.')) {
                    storageService.clearContinueWatching('all');
                    storageService.clearContinueWatching('kids');
                    storageService.clearContinueWatching('anime');
                    renderApp(); // Re-render settings page to show empty list
                }
            });
            document.getElementById('logout-btn')?.addEventListener('click', () => {
                if(confirm('Are you sure you want to log out? All your data will be cleared.')) {
                    storageService.logout();
                }
            });
        };

        const handleGenreChange = (e) => {
            const { genreId, genreName } = e.target.dataset;
            let selectedGenres = storageService.getSelectedGenres();

            if (e.target.checked) {
                selectedGenres[genreId] = genreName;
                const rowsContainer = document.getElementById('content-rows');
                const newRow = document.createElement('div');
                newRow.id = `genre-row-${genreId}`;
                rowsContainer.appendChild(newRow);
                newRow.innerHTML = ContentRow({ title: genreName, isLoading: true });
                tmdbService.discover('movie', { with_genres: genreId, sort_by: 'popularity.desc' }).then(data => {
                    newRow.innerHTML = ContentRow({ title: genreName, items: data.results, id: `genre-row-${genreId}` });
                });
            } else {
                delete selectedGenres[genreId];
                document.getElementById(`genre-row-${genreId}`)?.remove();
            }
            storageService.setSelectedGenres(selectedGenres);
        }

        const showSurpriseModal = async () => {
             const modalContainer = document.getElementById('modal-container');
             modalContainer.innerHTML = `
                 <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 fade-in">
                     <div class="animate-spin rounded-full h-24 w-24 border-t-2 border-b-2 border-[hsl(var(--primary))]"></div>
                 </div>
             `;
             
             const trending = await tmdbService.getTrending('all', 'week');
             const randomItem = trending.results[Math.floor(Math.random() * trending.results.length)];
             const details = randomItem.media_type === 'tv' ? await tmdbService.getTVShowDetails(randomItem.id) : await tmdbService.getMovieDetails(randomItem.id);

             const trailer = details.videos?.results?.find(v => v.site === 'YouTube' && (v.type === 'Trailer' || v.type === 'Teaser'));
             const isMovie = details.media_type === 'movie' || 'title' in details;

             modalContainer.innerHTML = `
                <div id="surprise-modal-backdrop" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 fade-in">
                    <div class="bg-surface-elevated rounded-lg w-full max-w-3xl modal-content relative overflow-hidden">
                        <div class="aspect-video bg-black">
                           ${trailer ? `<iframe src="https://www.youtube.com/embed/${trailer.key}?autoplay=1&mute=1&controls=0&showinfo=0&rel=0&iv_load_policy=3&modestbranding=1&loop=1&playlist=${trailer.key}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen class="w-full h-full"></iframe>` : `<img src="${tmdbService.getBackdropUrl(details.backdrop_path)}" class="w-full h-full object-cover">`}
                        </div>
                        <div class="p-6">
                            <h2 class="text-3xl font-bold">${details.title || details.name}</h2>
                            <p class="text-muted-foreground mt-2 line-clamp-3">${details.overview}</p>
                             <div class="flex gap-4 mt-6">
                                <a href="#info/${isMovie ? 'movie' : 'tv'}/${details.id}" id="modal-more-info" class="btn-primary w-full py-3 rounded-lg text-center font-semibold">More Info</a>
                                <button id="modal-close-btn" class="btn-secondary w-full py-3 rounded-lg font-semibold">Close</button>
                             </div>
                        </div>
                        <button id="modal-outer-close-btn" class="absolute top-3 right-3 p-2 bg-black/50 rounded-full hover:bg-black/80 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                </div>
             `;
             
             const closeModal = () => modalContainer.innerHTML = '';
             document.getElementById('surprise-modal-backdrop').addEventListener('click', (e) => { if(e.target.id === 'surprise-modal-backdrop') closeModal() });
             document.getElementById('modal-close-btn').addEventListener('click', closeModal);
             document.getElementById('modal-outer-close-btn').addEventListener('click', closeModal);
             document.getElementById('modal-more-info').addEventListener('click', closeModal);
        }

        const OnboardingModal = () => `
             <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 fade-in">
               <div class="bg-surface rounded-lg w-full max-w-sm m-4 p-6 space-y-4">
                 <h2 class="text-2xl font-bold">Welcome to BrokieFlix!</h2>
                 <p class="text-muted-foreground">Please enter a username to get started.</p>
                 <input id="username-input" type="text" class="w-full bg-surface-elevated border border-border rounded-md p-2" placeholder="Your username...">
                 <button id="save-username-btn" class="btn-primary w-full mt-4 py-2 rounded-lg font-semibold">Continue</button>
               </div>
             </div>
        `;

        const ApiKeyModal = () => `
            <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 fade-in">
              <div class="bg-surface rounded-lg w-full max-w-sm m-4 p-6 space-y-4">
                <h2 class="text-2xl font-bold">Enter TMDB API Key</h2>
                <p class="text-muted-foreground">This site requires a TMDB API key to function. Please get one for free from <a href="https://www.themoviedb.org/settings/api" target="_blank" class="text-[hsl(var(--primary))] underline">themoviedb.org</a>.</p>
                <input id="api-key-input" type="text" class="w-full bg-surface-elevated border border-border rounded-md p-2" placeholder="Your TMDB API Key...">
                <button id="save-api-key-btn" class="btn-primary w-full mt-4 py-2 rounded-lg font-semibold">Save and Continue</button>
              </div>
            </div>
        `;

        const initApp = () => {
            const user = storageService.getUser();
            if(!user) {
                render(OnboardingModal());
                document.getElementById('save-username-btn').addEventListener('click', () => {
                    const username = document.getElementById('username-input').value.trim();
                    if(username) {
                        storageService.setUser({ username });
                        initApp(); // Re-run init to check for API key
                    }
                });
                return;
            }

            TMDB_API_KEY = storageService.getApiKey();
            if (!TMDB_API_KEY) {
                render(ApiKeyModal());
                document.getElementById('save-api-key-btn').addEventListener('click', () => {
                    const key = document.getElementById('api-key-input').value.trim();
                    if (key) {
                        storageService.setApiKey(key);
                        location.reload();
                    }
                });
            } else {
                window.addEventListener('hashchange', renderApp);
                window.addEventListener('load', renderApp);
                renderApp();
            }
        };

        // --- INIT ---
        initApp();

    </script>
</body>
</html>
